name: Auto-merge Pull Requests

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
  check_suite:
    types: [completed]
  status: {}

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    # Security: Only auto-merge PRs from repository owner
    if: github.actor == github.repository_owner

    permissions:
      contents: write
      pull-requests: write
      checks: read

    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            // Get PR number from context
            const prNumber = context.payload.pull_request?.number ||
                            context.payload.check_suite?.pull_requests?.[0]?.number;

            if (!prNumber) {
              console.log('No PR found in context');
              return null;
            }

            // Fetch PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            return pr;

      - name: Check CI status
        id: ci-status
        if: steps.pr.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = JSON.parse('${{ steps.pr.outputs.result }}');

            // Get all check runs for PR head SHA
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });

            // Check if all required checks passed
            const allChecks = checkRuns.check_runs;
            const failedChecks = allChecks.filter(check =>
              check.conclusion && check.conclusion !== 'success' && check.conclusion !== 'skipped'
            );
            const pendingChecks = allChecks.filter(check =>
              !check.conclusion || check.status === 'in_progress' || check.status === 'queued'
            );

            console.log(`Total checks: ${allChecks.length}`);
            console.log(`Failed checks: ${failedChecks.length}`);
            console.log(`Pending checks: ${pendingChecks.length}`);

            if (failedChecks.length > 0) {
              console.log('‚ùå Some checks failed');
              return { canMerge: false, reason: 'failed_checks' };
            }

            if (pendingChecks.length > 0) {
              console.log('‚è≥ Checks still pending');
              return { canMerge: false, reason: 'pending_checks' };
            }

            console.log('‚úÖ All checks passed');
            return { canMerge: true };

      - name: Auto-merge PR
        if: |
          steps.pr.outputs.result != 'null' &&
          fromJSON(steps.ci-status.outputs.result).canMerge == true
        uses: actions/github-script@v7
        with:
          script: |
            const pr = JSON.parse('${{ steps.pr.outputs.result }}');

            try {
              // Merge the PR
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash',
                commit_title: `${pr.title} (#${pr.number})`,
                commit_message: pr.body || ''
              });

              console.log(`‚úÖ PR #${pr.number} auto-merged successfully`);

              // Delete branch after merge
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${pr.head.ref}`
                });
                console.log(`üóëÔ∏è Branch ${pr.head.ref} deleted`);
              } catch (deleteError) {
                console.log(`‚ö†Ô∏è Could not delete branch: ${deleteError.message}`);
              }

            } catch (error) {
              console.log(`‚ùå Auto-merge failed: ${error.message}`);
              core.setFailed(error.message);
            }

      - name: Comment on PR (if checks pending)
        if: |
          steps.pr.outputs.result != 'null' &&
          fromJSON(steps.ci-status.outputs.result).reason == 'pending_checks'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = JSON.parse('${{ steps.pr.outputs.result }}');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: '‚è≥ Auto-merge pending: waiting for CI checks to complete...'
            });
