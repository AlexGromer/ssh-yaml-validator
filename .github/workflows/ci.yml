name: CI - YAML Validator Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]
    paths:
      - '**.sh'
      - '.github/**'
  push:
    branches: [ main ]
    paths:
      - '**.sh'
      - '.github/**'

jobs:
  validate:
    name: Validate YAML Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          chmod +x yaml_validator.sh fix_yaml_issues.sh
          chmod +x DEMO.sh 2>/dev/null || true
          chmod +x install.sh 2>/dev/null || true

      - name: Check script syntax
        run: |
          bash -n yaml_validator.sh
          bash -n fix_yaml_issues.sh
          echo "✅ Bash syntax check passed"

      - name: Run validator on test samples
        run: |
          ./yaml_validator.sh test_samples/perfect_valid.yaml
          if [ $? -ne 0 ]; then
            echo "❌ Validator failed on perfect_valid.yaml"
            exit 1
          fi
          echo "✅ Validator test passed"

      - name: Test auto-fix module
        run: |
          mkdir -p test_output
          cp test_samples/tabs_error.yaml test_output/tabs_test.yaml
          cp test_samples/windows_encoding.yaml test_output/windows_test.yaml

          ./fix_yaml_issues.sh test_output/tabs_test.yaml
          ./fix_yaml_issues.sh test_output/windows_test.yaml

          echo "✅ Auto-fix tests completed"

      - name: Verify all test samples exist
        run: |
          expected_files=(
            "test_samples/perfect_valid.yaml"
            "test_samples/bom_error.yaml"
            "test_samples/boolean_errors.yaml"
            "test_samples/brackets_and_special_values.yaml"
            "test_samples/complex_errors.yaml"
            "test_samples/document_markers_errors.yaml"
            "test_samples/duplicate_keys.yaml"
            "test_samples/empty_file.yaml"
            "test_samples/empty_keys.yaml"
            "test_samples/invalid_labels.yaml"
            "test_samples/k8s_typos.yaml"
            "test_samples/list_spacing_errors.yaml"
            "test_samples/missing_k8s_metadata.yaml"
          )

          missing=0
          for file in "${expected_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing: $file"
              missing=$((missing + 1))
            fi
          done

          if [ $missing -gt 0 ]; then
            echo "❌ $missing test files are missing"
            exit 1
          fi

          echo "✅ All test samples present"

      - name: Check for executable permissions
        run: |
          if [ ! -x yaml_validator.sh ]; then
            echo "❌ yaml_validator.sh is not executable"
            exit 1
          fi
          if [ ! -x fix_yaml_issues.sh ]; then
            echo "❌ fix_yaml_issues.sh is not executable"
            exit 1
          fi
          echo "✅ Executable permissions verified"

  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
          ignore_paths: 'test_samples test_samples_fix'

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for sensitive data
        run: |
          # Check for potential secrets in shell scripts
          if grep -r -E "(password|secret|token|api_key|private_key)=" *.sh 2>/dev/null; then
            echo "⚠️ WARNING: Potential sensitive data found"
            exit 1
          fi
          echo "✅ No sensitive data detected"

      - name: Check for command injection vulnerabilities
        run: |
          # Check for unsafe eval or direct variable expansion in commands
          if grep -E "eval.*\$|system.*\$|exec.*\$" *.sh 2>/dev/null; then
            echo "⚠️ WARNING: Potential command injection risk"
            exit 1
          fi
          echo "✅ No command injection risks detected"
